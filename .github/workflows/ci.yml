name: CI

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: â” Setup pnpm@v10
        uses: pnpm/action-setup@v4

      - name: â” Setup Node@v22
        uses: actions/setup-node@v4
        with:
          cache: pnpm
          node-version: 22

      - name: ğŸ“¥ Install dependencies
        run: pnpm install

      - name: ğŸ— Build packages
        run: pnpm build:packages

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            packages/*/dist
            packages/svelte/.svelte-kit
          retention-days: 1
          include-hidden-files: true

  lint:
    name: Lint & Format
    needs: build
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: â” Setup pnpm@v10
        uses: pnpm/action-setup@v4

      - name: â” Setup Node@v22
        uses: actions/setup-node@v4
        with:
          cache: pnpm
          node-version: 22

      - name: ğŸ“¥ Install dependencies
        run: pnpm install

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: packages

      - name: ğŸ•µï¸ Lint + Format
        run: pnpm exec biome check .

  type-check:
    name: Type Check
    needs: build
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: â” Setup pnpm@v10
        uses: pnpm/action-setup@v4

      - name: â” Setup Node@v22
        uses: actions/setup-node@v4
        with:
          cache: pnpm
          node-version: 22

      - name: ğŸ“¥ Install dependencies
        run: pnpm install

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: packages

      - name: ğŸ” Verify types
        run: pnpm type-check

  test-node:
    name: Test (Node)
    needs: build
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: â” Setup pnpm@v10
        uses: pnpm/action-setup@v4

      - name: â” Setup Node@v22
        uses: actions/setup-node@v4
        with:
          cache: pnpm
          node-version: 22

      - name: ğŸ“¥ Install dependencies
        run: pnpm install

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: packages

      - name: ğŸ›¡ï¸ Test (Node)
        env:
          BASE_REF: ${{ github.base_ref || 'main' }}
        run: pnpm vitest run --project=web-node --changed="origin/$BASE_REF"

  test-browser:
    name: Test (Browser)
    needs: build
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: â” Setup pnpm@v10
        uses: pnpm/action-setup@v4

      - name: â” Setup Node@v22
        uses: actions/setup-node@v4
        with:
          cache: pnpm
          node-version: 22

      - name: ğŸ“¥ Install dependencies
        run: pnpm install

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: packages

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: ğŸ›¡ï¸ Test (Browser with coverage)
        env:
          BASE_REF: ${{ github.base_ref || 'main' }}
        run: pnpm vitest run --browser.headless --coverage --changed="origin/$BASE_REF"

      - name: Check coverage outputs
        if: always()
        id: coverage-check
        run: |
          echo "web=$(test -f packages/web/coverage/coverage-summary.json && echo true || echo false)" >> "$GITHUB_OUTPUT"
          echo "react=$(test -f packages/react/coverage/coverage-summary.json && echo true || echo false)" >> "$GITHUB_OUTPUT"
          echo "wc=$(test -f packages/wc/coverage/coverage-summary.json && echo true || echo false)" >> "$GITHUB_OUTPUT"

      - name: ğŸ“ Report coverage (web)
        if: always() && steps.coverage-check.outputs.web == 'true'
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          working-directory: packages/web
          name: '@lottiefiles/dotlottie-web'

      - name: ğŸ“ Report coverage (react)
        if: always() && steps.coverage-check.outputs.react == 'true'
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          working-directory: packages/react
          name: '@lottiefiles/dotlottie-react'

      - name: ğŸ“ Report coverage (wc)
        if: always() && steps.coverage-check.outputs.wc == 'true'
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          working-directory: packages/wc
          name: '@lottiefiles/dotlottie-wc'

  bundle-size:
    name: Bundle Size
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: â” Setup pnpm@v10
        uses: pnpm/action-setup@v4

      - name: â” Setup Node@v22
        uses: actions/setup-node@v4
        with:
          cache: pnpm
          node-version: 22

      - name: ğŸ“¥ Install dependencies
        run: pnpm install

      - name: ğŸ“ Report bundle size
        uses: andresz1/size-limit-action@v1
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          build_script: build:packages
